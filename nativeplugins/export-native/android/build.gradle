plugins {
    id 'com.android.library'
}

android {
    namespace 'com.cwriter.export'
    compileSdk 36

    defaultConfig {
        minSdk 26  // æé«˜minSdkåˆ°26ä»¥æ”¯æŒPOIåº“
        targetSdk 36
        versionCode 150
        versionName "1.1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
    }

    lint {
        abortOnError false
    }
    
    sourceSets {
        main {
            assets.srcDirs = ['assets']
        }
    }
    
    // è§£å†³META-INFå†²çªï¼ŒåŒæ—¶ä¿ç•™å­—ä½“èµ„æº
    packagingOptions {
        exclude 'META-INF/DEPENDENCIES'
        exclude 'META-INF/NOTICE'
        exclude 'META-INF/LICENSE'
        exclude 'META-INF/LICENSE.txt'
        exclude 'META-INF/NOTICE.txt'
        pickFirst 'META-INF/gradle/incremental.annotation.processors'
        // ç¡®ä¿åŒ…å«iTextå­—ä½“èµ„æº
        pickFirst '**/*.afm'
        pickFirst '**/*.ttf'
        pickFirst '**/*.otf'
    }
    
    // å¼ºåˆ¶åŒ…å«ä¾èµ–åº“åˆ°classes.jarä¸­
    publishing {
        singleVariant('release') {
            withSourcesJar()
            withJavadocJar()
        }
    }
}

repositories {
    google()
    mavenCentral()
    flatDir {
        dirs 'libs'
    }
}

dependencies {
    // uni-app SDK - éœ€è¦ä»uni-app SDKä¸­è·å–
    compileOnly fileTree(dir: 'libs', include: ['uniapp-v8-release.aar'])
    
    // FastJSON - uni-appä½¿ç”¨
    compileOnly 'com.alibaba:fastjson:1.2.83'
    
    // Android-compatible PDF library (æ›¿æ¢PDFBox)
    implementation 'com.itextpdf:itext7-core:7.2.5'
    
    // DOCXç”Ÿæˆåº“
    implementation('org.apache.poi:poi:5.2.3') {
        exclude group: 'commons-logging', module: 'commons-logging'
    }
    implementation('org.apache.poi:poi-ooxml:5.2.3') {
        exclude group: 'commons-logging', module: 'commons-logging'
        exclude group: 'org.apache.logging.log4j', module: 'log4j-api'
    }
    
    // XMLå¤„ç†ï¼ˆPOIä¾èµ–ï¼‰
    implementation 'org.apache.xmlbeans:xmlbeans:4.0.0'
    implementation 'org.apache.commons:commons-compress:1.21'
    implementation 'commons-codec:commons-codec:1.15'
    
    // æ·»åŠ ç¼ºå¤±çš„POIä¾èµ–
    implementation 'commons-io:commons-io:2.11.0'
    implementation 'org.apache.commons:commons-collections4:4.4'
    implementation 'org.apache.commons:commons-math3:3.6.1'
    
    // æ·»åŠ SLF4Jä½œä¸ºæ—¥å¿—æ¡†æ¶ï¼ˆé¿å…commons-loggingå†²çªï¼‰
    implementation 'org.slf4j:slf4j-android:1.7.36'
    
    // æ·»åŠ AndroidXæƒé™æ”¯æŒåº“
    implementation 'androidx.core:core:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    
    // æ·»åŠ æ–‡ä»¶æ“ä½œæ”¯æŒ
    implementation 'commons-io:commons-io:2.11.0'
}

// åœ¨æ‰“åŒ…å®Œæˆåæ‰‹åŠ¨å¤„ç†AARæ–‡ä»¶
tasks.whenTaskAdded { task ->
    if (task.name == 'bundleReleaseAar') {
        task.doLast {
            println "ğŸ”§ å¼€å§‹å¤„ç† AAR ä¾èµ–åˆå¹¶..."
            
            // æ‰¾åˆ°ç”Ÿæˆçš„AARæ–‡ä»¶
            def aarFile = file("build/outputs/aar/export-native-release.aar")
            if (!aarFile.exists()) {
                println "âŒ æœªæ‰¾åˆ° AAR æ–‡ä»¶: ${aarFile.absolutePath}"
                return
            }
        
        def tempDir = new File(project.buildDir, "tmp/fat-aar")
        tempDir.mkdirs()
        
        // è§£å‹AAR
        copy {
            from zipTree(aarFile)
            into tempDir
        }
        
        def classesJarFile = new File(tempDir, "classes.jar")
        if (classesJarFile.exists()) {
            println "ğŸ“¦ æ‰¾åˆ° classes.jarï¼Œå¼€å§‹æ·»åŠ ä¾èµ–åº“..."
            
            def extractDir = new File(tempDir, "classes-extract")
            extractDir.mkdirs()
            
            // è§£å‹åŸæœ‰çš„classes.jar
            copy {
                from zipTree(classesJarFile)
                into extractDir
            }
            
            // æ·»åŠ æ‰€æœ‰ä¾èµ–åº“çš„ç±»
            def dependencies = configurations.releaseRuntimeClasspath.files.findAll { it.name.endsWith('.jar') }
            println "ğŸ“¦ æ‰¾åˆ° ${dependencies.size()} ä¸ªä¾èµ–åº“"
            dependencies.each { dep ->
                println "ğŸ“¦ æ·»åŠ ä¾èµ–: ${dep.name}"
                copy {
                    from zipTree(dep)
                    into extractDir
                    exclude 'META-INF/*.RSA', 'META-INF/*.SF', 'META-INF/*.DSA'
                    exclude 'META-INF/DEPENDENCIES', 'META-INF/LICENSE*', 'META-INF/NOTICE*'
                }
            }
            
            // é‡æ–°æ‰“åŒ…æˆclasses.jarï¼ˆåŒ…å«classæ–‡ä»¶å’Œèµ„æºæ–‡ä»¶ï¼‰
            ant.jar(destfile: classesJarFile) {
                fileset(dir: extractDir, includes: '**/*.class')
                fileset(dir: extractDir, includes: '**/*.afm')
                fileset(dir: extractDir, includes: '**/*.ttf')
                fileset(dir: extractDir, includes: '**/*.otf')
                fileset(dir: extractDir, includes: '**/*.properties')
                fileset(dir: extractDir, includes: '**/*.xml')
            }
            
            // æ¸…ç†ä¸´æ—¶ç›®å½•
            delete extractDir
            
            // é‡æ–°æ‰“åŒ…AARï¼ˆåŒ…å«æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ›´æ–°åçš„classes.jarï¼‰
            ant.jar(destfile: aarFile) {
                fileset(dir: tempDir, includes: '**/*')
            }
            
            println "âœ… AAR å·²é‡æ–°æ‰“åŒ…ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–åº“"
            println "ğŸ“ æ–‡ä»¶ä½ç½®: ${aarFile.absolutePath}"
        } else {
            println "âŒ æœªæ‰¾åˆ° classes.jar æ–‡ä»¶"
        }
        
        // æ¸…ç†ä¸´æ—¶ç›®å½•
        delete tempDir
        }
    }
}


