<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>墨夜文书 - 地图生成</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B35',
                        secondary: '#4ECDC4',
                        tertiary: '#45B7D1',
                        success: '#96CEB4',
                        danger: '#FFEAA7',
                        warning: '#FD79A8',
                        dark: {
                            100: '#1A1A1A',
                            200: '#2D2D2D',
                            300: '#404040',
                            400: '#525252',
                            500: '#737373'
                        },
                        text: {
                            primary: '#FFFFFF',
                            secondary: '#B3B3B3',
                            tertiary: '#808080'
                        }
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    boxShadow: {
                        'card': '0 4px 12px rgba(0, 0, 0, 0.3)',
                        'fab': '0 6px 20px rgba(255, 107, 53, 0.4)'
                    }
                }
            }
        }
    </script>
    <style>
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .glass {
            background: rgba(45, 45, 45, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .map-container {
            background: linear-gradient(135deg, #2D2D2D 0%, #404040 100%);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .map-container.has-map {
            border-style: solid;
            border-color: rgba(255, 107, 53, 0.3);
        }
        
        .map-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
        }
        
        .map-container.has-map::before {
            opacity: 0.1;
        }
        
        .map-building {
            position: absolute;
            background: rgba(255, 107, 53, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 8px;
            color: white;
            font-size: 12px;
            cursor: move;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .map-building:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }
        
        .map-building.selected {
            border-color: #4ECDC4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.5);
        }
        
        .map-building.room {
            background: rgba(69, 183, 209, 0.8);
        }
        
        .map-building.corridor {
            background: rgba(150, 206, 180, 0.8);
        }
        
        .map-building.office {
            background: rgba(253, 121, 168, 0.8);
        }
        
        .map-building.start-point {
            background: rgba(150, 206, 180, 1);
            border-color: #96CEB4;
        }
        
        .map-building.end-point {
            background: rgba(253, 121, 168, 1);
            border-color: #FD79A8;
        }
        
        .tool-btn {
            transition: all 0.2s ease;
            background: rgba(45, 45, 45, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tool-btn:hover {
            background: rgba(64, 64, 64, 0.7);
            border-color: rgba(255, 107, 53, 0.3);
        }
        
        .tool-btn.active {
            background: rgba(255, 107, 53, 0.3);
            border-color: #FF6B35;
            color: #FF6B35;
        }
        
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #FF6B35;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .route-line {
            position: absolute;
            background: linear-gradient(90deg, #4ECDC4, #45B7D1);
            height: 3px;
            border-radius: 2px;
            opacity: 0.8;
            z-index: 10;
            transform-origin: left center;
        }
        
        .route-line::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -2.5px;
            width: 0;
            height: 0;
            border-left: 5px solid #4ECDC4;
            border-top: 3.5px solid transparent;
            border-bottom: 3.5px solid transparent;
        }
        
        .floating-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
    </style>
</head>
<body class="bg-dark-100 text-text-primary font-sans">
    <!-- 状态栏 -->
    <div id="status-bar" class="bg-dark-100 text-text-primary text-sm flex justify-between items-center px-4 py-1 safe-top">
        <div class="flex items-center space-x-1">
            <span>9:41</span>
        </div>
        <div class="flex items-center space-x-1">
            <i class="fas fa-signal text-xs"></i>
            <i class="fas fa-wifi text-xs"></i>
            <i class="fas fa-battery-three-quarters text-xs"></i>
        </div>
    </div>

    <!-- 主容器 -->
    <div id="main-container" class="min-h-screen bg-dark-100">
        <!-- 顶部导航栏 -->
        <header id="top-nav" class="glass px-4 py-3 border-b border-dark-300">
            <div class="flex items-center justify-between">
                <button id="back-btn" class="w-10 h-10 rounded-full bg-dark-300/50 backdrop-blur-md flex items-center justify-center">
                    <i class="fas fa-arrow-left text-text-secondary"></i>
                </button>
                <h1 id="page-title" class="text-lg font-semibold text-text-primary">地图生成</h1>
                <button id="save-map-btn" class="px-4 py-2 bg-primary/20 border border-primary/30 rounded-lg text-primary text-sm font-medium">
                    <i class="fas fa-save mr-1"></i>保存
                </button>
            </div>
        </header>

        <!-- 空间描述输入区域 -->
        <section id="description-section" class="p-4">
            <div class="glass rounded-lg p-4 shadow-card">
                <label for="space-description" class="block text-sm font-medium text-text-primary mb-3">
                    <i class="fas fa-edit mr-2 text-secondary"></i>空间描述
                </label>
                <textarea 
                    id="space-description" 
                    class="w-full h-24 bg-dark-300/50 border border-dark-400 rounded-lg p-3 text-text-primary placeholder-text-tertiary resize-none focus:border-primary focus:outline-none"
                    placeholder="请输入场景空间描述，例如：&#10;一个两层教学楼，一层有教室A、B、C和走廊，二层有教室D、E、F和办公室。走廊连接所有教室。"
                ></textarea>
                <div class="flex justify-end mt-3">
                    <button id="generate-map-btn" class="px-6 py-2 bg-primary rounded-lg text-white font-medium flex items-center">
                        <i class="fas fa-magic mr-2"></i>
                        <span id="generate-btn-text">AI生成地图</span>
                        <div id="generate-loading" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
            </div>
        </section>

        <!-- 地图显示区域 -->
        <section id="map-section" class="px-4 mb-4">
            <div class="glass rounded-lg p-4 shadow-card">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-semibold text-text-primary">
                        <i class="fas fa-map-marked-alt mr-2 text-tertiary"></i>地图预览
                    </h3>
                    <div id="map-status" class="text-xs text-text-secondary">
                        <i class="fas fa-info-circle mr-1"></i>点击生成地图
                    </div>
                </div>
                
                <!-- 地图容器 -->
                <div id="map-container" class="map-container w-full h-64 rounded-lg flex items-center justify-center relative">
                    <div id="map-placeholder" class="text-center text-text-secondary">
                        <i class="fas fa-map text-4xl mb-2 opacity-50"></i>
                        <p class="text-sm">暂无地图</p>
                        <p class="text-xs opacity-70">请输入空间描述并点击AI生成</p>
                    </div>
                    
                    <!-- 地图元素将在这里动态生成 -->
                    <div id="map-elements" class="absolute inset-0 hidden">
                        <!-- AI生成的地图建筑将插入这里 -->
                    </div>
                    
                    <!-- 路线显示层 -->
                    <div id="route-layer" class="absolute inset-0 pointer-events-none">
                        <!-- 路线线条将在这里绘制 -->
                    </div>
                    
                    <!-- 浮动提示 -->
                    <div id="floating-tooltip" class="floating-tooltip"></div>
                </div>
            </div>
        </section>

        <!-- 地图编辑工具栏 -->
        <section id="edit-tools-section" class="px-4 mb-4">
            <div class="glass rounded-lg p-4 shadow-card">
                <h3 class="text-base font-semibold text-text-primary mb-3">
                    <i class="fas fa-tools mr-2 text-secondary"></i>编辑工具
                </h3>
                <div class="flex space-x-2 overflow-x-auto pb-2">
                    <button id="tool-select" class="tool-btn active px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap flex items-center">
                        <i class="fas fa-mouse-pointer mr-2"></i>选择
                    </button>
                    <button id="tool-move" class="tool-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap flex items-center">
                        <i class="fas fa-arrows mr-2"></i>移动
                    </button>
                    <button id="tool-create-room" class="tool-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap flex items-center">
                        <i class="fas fa-plus-square mr-2"></i>创建房间
                    </button>
                    <button id="tool-delete" class="tool-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap flex items-center">
                        <i class="fas fa-trash mr-2"></i>删除
                    </button>
                    <button id="tool-clear" class="tool-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap flex items-center">
                        <i class="fas fa-eraser mr-2"></i>清除
                    </button>
                </div>
            </div>
        </section>

        <!-- 路线规划区域 -->
        <section id="route-section" class="px-4 mb-6">
            <div class="glass rounded-lg p-4 shadow-card">
                <h3 class="text-base font-semibold text-text-primary mb-3">
                    <i class="fas fa-route mr-2 text-tertiary"></i>路线规划
                </h3>
                
                <!-- 起点终点选择 -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm text-text-secondary mb-1">起点</label>
                        <select id="start-point" class="w-full bg-dark-300/50 border border-dark-400 rounded-lg p-2 text-text-primary text-sm focus:border-primary focus:outline-none">
                            <option value="">选择起点</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-text-secondary mb-1">终点</label>
                        <select id="end-point" class="w-full bg-dark-300/50 border border-dark-400 rounded-lg p-2 text-text-primary text-sm focus:border-primary focus:outline-none">
                            <option value="">选择终点</option>
                        </select>
                    </div>
                </div>
                
                <!-- 路线操作按钮 -->
                <div class="flex space-x-2 mb-4">
                    <button id="generate-route-btn" class="flex-1 px-4 py-2 bg-secondary rounded-lg text-white font-medium flex items-center justify-center">
                        <i class="fas fa-route mr-2"></i>生成路线
                    </button>
                    <button id="export-route-btn" class="px-4 py-2 bg-tertiary rounded-lg text-white font-medium flex items-center" disabled>
                        <i class="fas fa-download mr-2"></i>导出路线
                    </button>
                </div>
                
                <!-- 路线描述结果 -->
                <div id="route-result" class="bg-dark-300/30 border border-dark-400 rounded-lg p-3 hidden">
                    <h4 class="text-sm font-medium text-text-primary mb-2">
                        <i class="fas fa-info-circle mr-2 text-secondary"></i>路线描述
                    </h4>
                    <p id="route-description" class="text-sm text-text-secondary leading-relaxed">
                        请选择起点和终点后生成路线
                    </p>
                </div>
            </div>
        </section>

    </div>

    <!-- 成功提示弹窗 -->
    <div id="success-toast" class="fixed top-20 left-4 right-4 bg-success/20 border border-success/30 rounded-lg p-4 text-success text-sm font-medium transform -translate-y-full transition-transform duration-300 z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="toast-message">操作成功</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 地图数据
            let currentMapData = null;
            let selectedBuilding = null;
            let startPoint = null;
            let endPoint = null;
            let currentRoute = null;
            let isDragging = false;
            let currentTool = 'select';

            // 返回按钮
            document.querySelector('#back-btn').addEventListener('click', function() {
                window.location.href = 'P-SERVICE.html';
            });

            // AI生成地图
            document.querySelector('#generate-map-btn').addEventListener('click', function() {
                const description = document.querySelector('#space-description').value.trim();
                if (!description) {
                    showToast('请输入空间描述');
                    return;
                }

                // 显示加载状态
                const btn = this;
                const btnText = document.querySelector('#generate-btn-text');
                const loading = document.querySelector('#generate-loading');
                
                btn.disabled = true;
                btnText.textContent = '生成中...';
                loading.classList.remove('hidden');
                
                // 模拟AI生成地图
                setTimeout(() => {
                    generateMap(description);
                    
                    // 恢复按钮状态
                    btn.disabled = false;
                    btnText.textContent = 'AI生成地图';
                    loading.classList.add('hidden');
                    
                    showToast('地图生成成功');
                }, 2000);
            });

            // 地图生成逻辑
            function generateMap(description) {
                currentMapData = generateMockMapData(description);
                renderMap();
                updateBuildingSelectors();
                
                document.querySelector('#map-container').classList.add('has-map');
                document.querySelector('#map-placeholder').classList.add('hidden');
                document.querySelector('#map-elements').classList.remove('hidden');
                document.querySelector('#map-status').innerHTML = '<i class="fas fa-check-circle mr-1 text-success"></i>地图已生成';
            }

            // 生成模拟地图数据
            function generateMockMapData(description) {
                // 简化的地图生成逻辑，实际项目中会调用AI API
                return {
                    buildings: [
                        { id: 'roomA', name: '教室A', type: 'room', x: 50, y: 80, width: 80, height: 60 },
                        { id: 'roomB', name: '教室B', type: 'room', x: 150, y: 80, width: 80, height: 60 },
                        { id: 'roomC', name: '教室C', type: 'room', x: 250, y: 80, width: 80, height: 60 },
                        { id: 'corridor1', name: '走廊', type: 'corridor', x: 50, y: 150, width: 280, height: 30 },
                        { id: 'roomD', name: '教室D', type: 'room', x: 50, y: 200, width: 80, height: 60 },
                        { id: 'roomE', name: '教室E', type: 'room', x: 150, y: 200, width: 80, height: 60 },
                        { id: 'roomF', name: '教室F', type: 'room', x: 250, y: 200, width: 80, height: 60 },
                        { id: 'office', name: '办公室', type: 'office', x: 150, y: 280, width: 80, height: 60 }
                    ]
                };
            }

            // 渲染地图
            function renderMap() {
                const mapElements = document.querySelector('#map-elements');
                mapElements.innerHTML = '';
                
                currentMapData.buildings.forEach(building => {
                    const buildingElement = createBuildingElement(building);
                    mapElements.appendChild(buildingElement);
                });
                
                // 清除现有路线
                clearRoute();
            }

            // 创建建筑元素
            function createBuildingElement(building) {
                const element = document.createElement('div');
                element.id = `building-${building.id}`;
                element.className = `map-building ${building.type}`;
                element.style.left = `${building.x}px`;
                element.style.top = `${building.y}px`;
                element.style.width = `${building.width}px`;
                element.style.height = `${building.height}px`;
                element.textContent = building.name;
                element.dataset.buildingId = building.id;
                
                // 添加交互事件
                addBuildingEvents(element, building);
                
                return element;
            }

            // 添加建筑交互事件
            function addBuildingEvents(element, building) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (currentTool === 'select') {
                        selectBuilding(element, building);
                    } else if (currentTool === 'delete') {
                        deleteBuilding(building.id);
                    }
                });
                
                element.addEventListener('mousedown', function(e) {
                    if (currentTool === 'move') {
                        startDrag(e, element, building);
                    }
                });
                
                element.addEventListener('mouseenter', function(e) {
                    showTooltip(e, building.name);
                });
                
                element.addEventListener('mouseleave', function() {
                    hideTooltip();
                });
            }

            // 选择建筑
            function selectBuilding(element, building) {
                // 清除之前的选择
                if (selectedBuilding) {
                    selectedBuilding.classList.remove('selected');
                }
                
                // 选择新建筑
                selectedBuilding = element;
                element.classList.add('selected');
            }

            // 删除建筑
            function deleteBuilding(buildingId) {
                if (confirm('确定要删除这个建筑吗？')) {
                    currentMapData.buildings = currentMapData.buildings.filter(b => b.id !== buildingId);
                    renderMap();
                    updateBuildingSelectors();
                    showToast('建筑已删除');
                }
            }

            // 开始拖拽
            function startDrag(e, element, building) {
                isDragging = true;
                const startX = e.clientX - building.x;
                const startY = e.clientY - building.y;
                
                function onMouseMove(e) {
                    if (!isDragging) return;
                    
                    const mapContainer = document.querySelector('#map-container');
                    const rect = mapContainer.getBoundingClientRect();
                    
                    let newX = e.clientX - rect.left - startX;
                    let newY = e.clientY - rect.top - startY;
                    
                    // 限制在地图容器内
                    newX = Math.max(10, Math.min(newX, rect.width - building.width - 10));
                    newY = Math.max(10, Math.min(newY, rect.height - building.height - 10));
                    
                    element.style.left = `${newX}px`;
                    element.style.top = `${newY}px`;
                    
                    // 更新数据
                    const buildingData = currentMapData.buildings.find(b => b.id === building.id);
                    if (buildingData) {
                        buildingData.x = newX;
                        buildingData.y = newY;
                    }
                }
                
                function onMouseUp() {
                    isDragging = false;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }

            // 显示提示
            function showTooltip(e, text) {
                const tooltip = document.querySelector('#floating-tooltip');
                tooltip.textContent = text;
                tooltip.style.left = `${e.clientX + 10}px`;
                tooltip.style.top = `${e.clientY - 30}px`;
                tooltip.style.opacity = '1';
            }

            // 隐藏提示
            function hideTooltip() {
                const tooltip = document.querySelector('#floating-tooltip');
                tooltip.style.opacity = '0';
            }

            // 更新建筑选择器
            function updateBuildingSelectors() {
                const startSelect = document.querySelector('#start-point');
                const endSelect = document.querySelector('#end-point');
                
                // 清空现有选项
                startSelect.innerHTML = '<option value="">选择起点</option>';
                endSelect.innerHTML = '<option value="">选择终点</option>';
                
                // 添加建筑选项
                currentMapData?.buildings.forEach(building => {
                    const startOption = document.createElement('option');
                    startOption.value = building.id;
                    startOption.textContent = building.name;
                    startSelect.appendChild(startOption);
                    
                    const endOption = document.createElement('option');
                    endOption.value = building.id;
                    endOption.textContent = building.name;
                    endSelect.appendChild(endOption);
                });
            }

            // 工具按钮切换
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 清除所有按钮的激活状态
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    
                    // 激活当前按钮
                    this.classList.add('active');
                    
                    // 更新当前工具
                    currentTool = this.id.replace('tool-', '');
                    
                    // 特殊处理创建房间工具
                    if (currentTool === 'create-room') {
                        createNewRoom();
                        // 自动切换回选择工具
                        setTimeout(() => {
                            document.querySelector('#tool-select').click();
                        }, 100);
                    }
                });
            });

            // 创建新房间
            function createNewRoom() {
                if (!currentMapData) {
                    showToast('请先生成地图');
                    return;
                }
                
                const newId = 'room' + Date.now();
                const newBuilding = {
                    id: newId,
                    name: '新房间',
                    type: 'room',
                    x: 100,
                    y: 100,
                    width: 80,
                    height: 60
                };
                
                currentMapData.buildings.push(newBuilding);
                renderMap();
                updateBuildingSelectors();
                showToast('新房间已创建');
            }

            // 清除地图
            document.querySelector('#tool-clear').addEventListener('click', function() {
                if (confirm('确定要清除整个地图吗？')) {
                    currentMapData = null;
                    selectedBuilding = null;
                    startPoint = null;
                    endPoint = null;
                    
                    document.querySelector('#map-container').classList.remove('has-map');
                    document.querySelector('#map-placeholder').classList.remove('hidden');
                    document.querySelector('#map-elements').classList.add('hidden');
                    document.querySelector('#map-status').innerHTML = '<i class="fas fa-info-circle mr-1"></i>点击生成地图';
                    
                    updateBuildingSelectors();
                    clearRoute();
                    showToast('地图已清除');
                }
            });

            // 起点终点选择变化
            document.querySelector('#start-point').addEventListener('change', function() {
                startPoint = this.value;
                updateRoutePoints();
            });

            document.querySelector('#end-point').addEventListener('change', function() {
                endPoint = this.value;
                updateRoutePoints();
            });

            // 更新路线点
            function updateRoutePoints() {
                // 清除之前的起点终点标记
                document.querySelectorAll('.map-building').forEach(building => {
                    building.classList.remove('start-point', 'end-point');
                });
                
                // 添加新的标记
                if (startPoint) {
                    const startElement = document.querySelector(`#building-${startPoint}`);
                    if (startElement) {
                        startElement.classList.add('start-point');
                    }
                }
                
                if (endPoint) {
                    const endElement = document.querySelector(`#building-${endPoint}`);
                    if (endElement) {
                        endElement.classList.add('end-point');
                    }
                }
                
                // 清除现有路线
                clearRoute();
            }

            // 生成路线
            document.querySelector('#generate-route-btn').addEventListener('click', function() {
                if (!startPoint || !endPoint) {
                    showToast('请选择起点和终点');
                    return;
                }
                
                if (startPoint === endPoint) {
                    showToast('起点和终点不能相同');
                    return;
                }
                
                generateRoute();
            });

            // 生成路线
            function generateRoute() {
                clearRoute();
                
                const startBuilding = currentMapData.buildings.find(b => b.id === startPoint);
                const endBuilding = currentMapData.buildings.find(b => b.id === endPoint);
                
                if (!startBuilding || !endBuilding) {
                    showToast('无法找到起点或终点');
                    return;
                }
                
                // 简化的路线生成逻辑
                currentRoute = {
                    start: startBuilding,
                    end: endBuilding,
                    path: generatePath(startBuilding, endBuilding)
                };
                
                renderRoute();
                updateRouteDescription();
                
                document.querySelector('#export-route-btn').disabled = false;
                showToast('路线生成成功');
            }

            // 生成路径
            function generatePath(start, end) {
                // 简化的路径生成，实际项目中会使用路径查找算法
                return [
                    { x: start.x + start.width / 2, y: start.y + start.height / 2 },
                    { x: (start.x + start.width / 2 + end.x + end.width / 2) / 2, y: start.y + start.height / 2 },
                    { x: (start.x + start.width / 2 + end.x + end.width / 2) / 2, y: end.y + end.height / 2 },
                    { x: end.x + end.width / 2, y: end.y + end.height / 2 }
                ];
            }

            // 渲染路线
            function renderRoute() {
                const routeLayer = document.querySelector('#route-layer');
                
                currentRoute.path.forEach((point, index) => {
                    if (index < currentRoute.path.length - 1) {
                        const nextPoint = currentRoute.path[index + 1];
                        const line = createRouteLine(point, nextPoint);
                        routeLayer.appendChild(line);
                    }
                });
            }

            // 创建路线线条
            function createRouteLine(start, end) {
                const line = document.createElement('div');
                line.className = 'route-line';
                
                const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                const angle = Math.atan2(end.y - start.y, end.x - start.x) * 180 / Math.PI;
                
                line.style.left = `${start.x}px`;
                line.style.top = `${start.y - 1.5}px`;
                line.style.width = `${length}px`;
                line.style.transform = `rotate(${angle}deg)`;
                
                return line;
            }

            // 清除路线
            function clearRoute() {
                const routeLayer = document.querySelector('#route-layer');
                routeLayer.innerHTML = '';
                currentRoute = null;
                
                document.querySelector('#export-route-btn').disabled = true;
                document.querySelector('#route-result').classList.add('hidden');
            }

            // 更新路线描述
            function updateRouteDescription() {
                const startName = currentRoute.start.name;
                const endName = currentRoute.end.name;
                
                const description = `从${startName}出发，经过走廊，前往${endName}。总距离约${Math.round(getRouteDistance())}米。`;
                
                document.querySelector('#route-description').textContent = description;
                document.querySelector('#route-result').classList.remove('hidden');
            }

            // 获取路线距离
            function getRouteDistance() {
                let distance = 0;
                currentRoute.path.forEach((point, index) => {
                    if (index < currentRoute.path.length - 1) {
                        const nextPoint = currentRoute.path[index + 1];
                        distance += Math.sqrt(Math.pow(nextPoint.x - point.x, 2) + Math.pow(nextPoint.y - point.y, 2));
                    }
                });
                return distance * 0.1; // 缩放系数
            }

            // 导出路线
            document.querySelector('#export-route-btn').addEventListener('click', function() {
                if (!currentRoute) {
                    showToast('请先生成路线');
                    return;
                }
                
                const routeText = document.querySelector('#route-description').textContent;
                
                // 复制到剪贴板
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(routeText).then(() => {
                        showToast('路线描述已复制到剪贴板');
                    }).catch(() => {
                        fallbackCopyTextToClipboard(routeText);
                    });
                } else {
                    fallbackCopyTextToClipboard(routeText);
                }
            });

            // 备用复制方法
            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showToast('路线描述已复制到剪贴板');
                } catch (err) {
                    showToast('复制失败，请手动复制');
                }
                
                document.body.removeChild(textArea);
            }

            // 保存地图
            document.querySelector('#save-map-btn').addEventListener('click', function() {
                if (!currentMapData) {
                    showToast('请先生成地图');
                    return;
                }
                
                // 模拟保存操作
                showToast('地图保存成功');
            });

            // 显示提示
            function showToast(message) {
                const toast = document.querySelector('#success-toast');
                const messageEl = document.querySelector('#toast-message');
                
                messageEl.textContent = message;
                toast.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    toast.style.transform = 'translateY(-100%)';
                }, 3000);
            }

            // 地图容器点击事件（取消选择）
            document.querySelector('#map-container').addEventListener('click', function() {
                if (selectedBuilding) {
                    selectedBuilding.classList.remove('selected');
                    selectedBuilding = null;
                }
            });
        });
    </script>
</body>
</html>